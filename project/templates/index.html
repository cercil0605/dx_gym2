{% extends "base.html" %}

{% block title %}体育館予約{% endblock %}

{% block content %}
<h1 class="title has-text-centered">体育館予約システム</h1>
<div class="box">
    <h2 class="subtitle">予約可能週</h2>
    <p>次の予約可能週：<strong>{{ start_of_week }}</strong> から <strong>{{ end_of_week }}</strong></p>

    <h2 class="subtitle">予約フォーム</h2>
    <form action="/reserve" method="post">
        <div class="field">
            <label class="label" for="date">予約したい日付：</label>
            <div class="control">
                <input class="input" type="date" id="date" name="date" value="{{ reserved_date }}"
                       min="{{ start_of_week }}" max="{{ end_of_week }}">
            </div>
        </div>
        <div class="field">
            <label class="label" for="time">予約したい時間帯：</label>
            <div class="control">
                <div class="select">
                    <select id="time" name="time">
                        {% for time in available_times %}
                            {% if time in booked_times %}
                                <option value="{{ time }}" disabled>{{ time }}（予約済み）</option>
                            {% else %}
                                <option value="{{ time }}">{{ time }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="control">
            <button class="button is-link" type="submit">予約する</button>
        </div>
    </form>

    <div id="popup" class="popup">
        <p>選択された時間帯は既に予約されています。別の時間帯を選択してください。</p>
    </div>

    <h2 class="subtitle">予約可能時間帯</h2>
    <ul>
        {% for time in available_times %}
        <li>
            {{ time }}
            {% if time in booked_times %}
            <span class="tag is-danger">予約済み</span>
            {% endif %}
        </li>
        {% endfor %}
    </ul>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var dateInput = document.getElementById('date');
        var timeSelect = document.getElementById('time');
        var popup = document.getElementById('popup');

        updateBookedTimes();

        dateInput.addEventListener('change', function() {
            var selectedDate = dateInput.value;
            window.location.href = `/?date=${selectedDate}`;
        });

        timeSelect.addEventListener('change', function() {
            if (this.querySelector(':checked').disabled) {
                popup.style.display = 'block';
            } else {
                popup.style.display = 'none';
            }
        });

        function updateBookedTimes() {
            var selectedDate = dateInput.value;
            fetch(`/api/get_reservations?date=${selectedDate}`)
            .then(response => response.json())
            .then(data => {
                var bookedTimes = data;
                Array.from(timeSelect.options).forEach(option => {
                    option.disabled = false;
                });
                bookedTimes.forEach(bookedTime => {
                    var option = timeSelect.querySelector(`option[value="${bookedTime}"]`);
                    if (option) {
                        option.disabled = true;
                    }
                });
            })
            .catch(error => console.error('エラー:', error));
        }
    });
</script>
{% endblock %}
